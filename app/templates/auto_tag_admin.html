{% extends "base.html" %}

{% block title %}Auto-Tag Administration - Goldco CMS{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-5">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800 dark:text-neutral-200">
        Auto-Tagging Administration
      </h1>
      <p class="text-sm text-gray-600 dark:text-neutral-400">
        Manage keyword mappings and regenerate auto-tags
      </p>
    </div>
    <a
      href="{{ url_for('quotes') }}"
      class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 dark:bg-neutral-800 dark:border-neutral-700 dark:text-neutral-300 dark:hover:bg-neutral-700"
    >
      Back to Quotes
    </a>
  </div>
</div>

<!-- Action Cards -->
<div class="grid sm:grid-cols-2 gap-4 mb-6">
  <!-- Reload Keywords Card -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm dark:bg-neutral-800 dark:border-neutral-700">
    <div class="p-6">
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0">
          <div class="inline-flex items-center justify-center size-12 rounded-lg bg-blue-100 dark:bg-blue-900/30">
            <svg class="size-6 text-blue-600 dark:text-blue-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
              <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
              <path d="M16 16h5v5"/>
            </svg>
          </div>
        </div>
        <div class="flex-grow">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-neutral-200 mb-1">
            Reload Keywords
          </h3>
          <p class="text-sm text-gray-600 dark:text-neutral-400 mb-4">
            Reload keyword mappings from <code class="text-xs bg-gray-100 dark:bg-neutral-700 px-1 rounded">app/data/auto-tag-keywords.csv</code> without restarting the application.
          </p>
          <form method="POST" action="{{ url_for('reload_keywords') }}" onsubmit="return confirm('Reload keyword mappings from CSV file?');">
            <button
              type="submit"
              class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:outline-hidden focus:bg-blue-700"
            >
              <svg class="size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
              </svg>
              Reload Keywords
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Reprocess All Quotes Card -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm dark:bg-neutral-800 dark:border-neutral-700">
    <div class="p-6">
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0">
          <div class="inline-flex items-center justify-center size-12 rounded-lg bg-green-100 dark:bg-green-900/30">
            <svg class="size-6 text-green-600 dark:text-green-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
              <path d="M21 12a9 9 0 1 1-18 0"/>
            </svg>
          </div>
        </div>
        <div class="flex-grow">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-neutral-200 mb-1">
            Reprocess All Quotes
          </h3>
          <p class="text-sm text-gray-600 dark:text-neutral-400 mb-4">
            Regenerate auto-tags for all existing quotes based on current keyword mappings. User-removed tags will be respected.
          </p>
          <form method="POST" action="{{ url_for('reprocess_all_quotes') }}" onsubmit="return confirm('Reprocess all quotes? This may take a few moments.');">
            <button
              type="submit"
              class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-green-600 text-white hover:bg-green-700 focus:outline-hidden focus:bg-green-700"
            >
              <svg class="size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="16 18 22 12 16 6"/>
                <polyline points="8 6 2 12 8 18"/>
              </svg>
              Reprocess All
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Card -->
<div class="bg-white border border-gray-200 rounded-xl shadow-sm dark:bg-neutral-800 dark:border-neutral-700">
  <div class="px-6 py-4 border-b border-gray-200 dark:border-neutral-700">
    <h2 class="text-xl font-semibold text-gray-800 dark:text-neutral-200">
      Auto-Tagging Statistics
    </h2>
  </div>

  <div class="p-6">
    <!-- Overview Stats -->
    <div class="grid sm:grid-cols-4 gap-4 mb-6">
      <div class="text-center p-4 bg-gray-50 dark:bg-neutral-900 rounded-lg">
        <div class="text-3xl font-bold text-blue-600 dark:text-blue-500">{{ stats.total_quotes }}</div>
        <div class="text-sm text-gray-600 dark:text-neutral-400 mt-1">Total Quotes</div>
      </div>
      <div class="text-center p-4 bg-gray-50 dark:bg-neutral-900 rounded-lg">
        <div class="text-3xl font-bold text-green-600 dark:text-green-500">{{ stats.quotes_with_auto_tags }}</div>
        <div class="text-sm text-gray-600 dark:text-neutral-400 mt-1">With Auto-Tags</div>
      </div>
      <div class="text-center p-4 bg-gray-50 dark:bg-neutral-900 rounded-lg">
        <div class="text-3xl font-bold text-purple-600 dark:text-purple-500">{{ stats.coverage_percentage }}%</div>
        <div class="text-sm text-gray-600 dark:text-neutral-400 mt-1">Coverage</div>
      </div>
      <div class="text-center p-4 bg-gray-50 dark:bg-neutral-900 rounded-lg">
        <div class="text-3xl font-bold text-orange-600 dark:text-orange-500">{{ stats.total_keyword_mappings }}</div>
        <div class="text-sm text-gray-600 dark:text-neutral-400 mt-1">Keywords Loaded</div>
      </div>
    </div>

    <!-- Top Tags -->
    {% if stats.top_tags %}
    <div>
      <h3 class="text-lg font-semibold text-gray-800 dark:text-neutral-200 mb-3">
        Most Frequently Applied Auto-Tags
      </h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
          <thead class="bg-gray-50 dark:bg-neutral-900">
            <tr>
              <th scope="col" class="px-4 py-3 text-start text-xs font-semibold uppercase text-gray-800 dark:text-neutral-200">
                Tag
              </th>
              <th scope="col" class="px-4 py-3 text-start text-xs font-semibold uppercase text-gray-800 dark:text-neutral-200">
                Frequency
              </th>
              <th scope="col" class="px-4 py-3 text-start text-xs font-semibold uppercase text-gray-800 dark:text-neutral-200">
                Usage
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-neutral-700">
            {% for tag, count in stats.top_tags %}
            <tr>
              <td class="px-4 py-3 whitespace-nowrap">
                <span class="inline-flex items-center gap-1.5 py-0.5 px-2 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-500">
                  <svg class="shrink-0 size-2.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                    <path d="M21 12a9 9 0 1 1-18 0"/>
                  </svg>
                  {{ tag }}
                </span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <span class="text-sm font-semibold text-gray-800 dark:text-neutral-200">{{ count }}</span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <div class="flex-grow bg-gray-200 dark:bg-neutral-700 rounded-full h-2 max-w-[200px]">
                    <div class="bg-green-600 dark:bg-green-500 h-2 rounded-full" style="width: {% if stats.quotes_with_auto_tags > 0 %}{{ (count / stats.quotes_with_auto_tags * 100)|round(1) }}%{% else %}0%{% endif %}"></div>
                  </div>
                  <span class="text-xs text-gray-600 dark:text-neutral-400">
                    {% if stats.quotes_with_auto_tags > 0 %}
                      {{ (count / stats.quotes_with_auto_tags * 100)|round(1) }}%
                    {% else %}
                      0%
                    {% endif %}
                  </span>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="text-center py-8">
      <p class="text-gray-500 dark:text-neutral-400">No auto-tags have been applied yet.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Instructions -->
<div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900/20 dark:border-blue-800">
  <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-400 mb-2">How to Update Keywords</h3>
  <ol class="text-sm text-blue-700 dark:text-blue-300 space-y-1 list-decimal list-inside">
    <li>Edit the CSV file at <code class="text-xs bg-blue-100 dark:bg-blue-900/50 px-1 rounded">app/data/auto-tag-keywords.csv</code></li>
    <li>Click "Reload Keywords" above to load the updated mappings</li>
    <li>Click "Reprocess All" to apply the new keywords to existing quotes</li>
  </ol>
  <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">
    CSV format: <code>keyword,tags</code> where tags are comma-separated (e.g., <code>gold,"gold, precious metals"</code>)
  </p>
</div>

{% endblock %}
